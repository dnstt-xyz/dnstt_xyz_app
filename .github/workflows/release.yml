name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.2.0-beta)'
        required: true
        default: 'v2.2.0-beta'

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      # Android uses the pre-compiled slipstream binary from jniLibs/
      # (committed to repo). To rebuild, run scripts/build_slipstream_android.sh

      - name: Get dependencies
        run: flutter pub get

      - name: Build APKs (split by ABI)
        run: flutter build apk --release --split-per-abi --obfuscate --split-debug-info=/tmp/debug-info

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
            build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
            build/app/outputs/flutter-apk/app-x86_64-release.apk

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Go library for macOS ARM64
        run: |
          cd go_src
          CGO_ENABLED=1 GOARCH=arm64 go build -trimpath -ldflags="-s -w" -buildmode=c-shared -o libdnstt.dylib ./desktop
          mkdir -p ../macos/Runner/Libraries
          cp libdnstt.dylib ../macos/Runner/Libraries/

      - name: Build slipstream-client for macOS ARM64
        run: |
          cd vendor/slipstream-rust
          RUSTFLAGS="--remap-path-prefix=$(pwd)=/build/s --remap-path-prefix=$HOME=/_" \
          cargo build -p slipstream-client --release --features openssl-vendored
          cp target/release/slipstream-client ../../macos/Runner/Libraries/slipstream-client
          chmod +x ../../macos/Runner/Libraries/slipstream-client

      - name: Get dependencies
        run: flutter pub get

      - name: Build macOS app
        run: flutter build macos --release

      - name: Bundle libraries into app
        run: |
          FRAMEWORKS="build/macos/Build/Products/Release/DNSTT_XYZ.app/Contents/Frameworks"
          # DNSTT library
          cp go_src/libdnstt.dylib "$FRAMEWORKS/"
          install_name_tool -id "@rpath/libdnstt.dylib" "$FRAMEWORKS/libdnstt.dylib"
          codesign --force --sign - "$FRAMEWORKS/libdnstt.dylib"
          # Slipstream client (statically linked, no OpenSSL dylibs needed with vendored feature)
          cp macos/Runner/Libraries/slipstream-client "$FRAMEWORKS/slipstream-client"
          chmod +x "$FRAMEWORKS/slipstream-client"
          codesign --force --sign - --entitlements macos/Runner/SlipstreamInherit.entitlements "$FRAMEWORKS/slipstream-client"
          # Re-sign entire app
          codesign --force --deep --sign - "build/macos/Build/Products/Release/DNSTT_XYZ.app"
          # Re-apply inherit entitlement (deep signing strips per-binary entitlements)
          codesign --force --sign - --entitlements macos/Runner/SlipstreamInherit.entitlements "$FRAMEWORKS/slipstream-client"

      - name: Create DMG
        run: |
          hdiutil create -volname "DNSTT Client" \
            -srcfolder build/macos/Build/Products/Release/DNSTT_XYZ.app \
            -ov -format UDZO \
            DNSTT-Client-macOS-arm64.dmg

      - name: Upload macOS ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-dmg
          path: DNSTT-Client-macOS-arm64.dmg

  build-macos-intel:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Go library for macOS Intel
        run: |
          cd go_src
          CGO_ENABLED=1 GOARCH=amd64 go build -trimpath -ldflags="-s -w" -buildmode=c-shared -o libdnstt.dylib ./desktop
          mkdir -p ../macos/Runner/Libraries
          cp libdnstt.dylib ../macos/Runner/Libraries/

      - name: Build slipstream-client for macOS Intel
        run: |
          cd vendor/slipstream-rust
          RUSTFLAGS="--remap-path-prefix=$(pwd)=/build/s --remap-path-prefix=$HOME=/_" \
          cargo build -p slipstream-client --release --features openssl-vendored
          cp target/release/slipstream-client ../../macos/Runner/Libraries/slipstream-client
          chmod +x ../../macos/Runner/Libraries/slipstream-client

      - name: Get dependencies
        run: flutter pub get

      - name: Build macOS app
        run: flutter build macos --release

      - name: Bundle libraries into app
        run: |
          FRAMEWORKS="build/macos/Build/Products/Release/DNSTT_XYZ.app/Contents/Frameworks"
          cp go_src/libdnstt.dylib "$FRAMEWORKS/"
          install_name_tool -id "@rpath/libdnstt.dylib" "$FRAMEWORKS/libdnstt.dylib"
          codesign --force --sign - "$FRAMEWORKS/libdnstt.dylib"
          cp macos/Runner/Libraries/slipstream-client "$FRAMEWORKS/slipstream-client"
          chmod +x "$FRAMEWORKS/slipstream-client"
          codesign --force --sign - --entitlements macos/Runner/SlipstreamInherit.entitlements "$FRAMEWORKS/slipstream-client"
          codesign --force --deep --sign - "build/macos/Build/Products/Release/DNSTT_XYZ.app"
          codesign --force --sign - --entitlements macos/Runner/SlipstreamInherit.entitlements "$FRAMEWORKS/slipstream-client"

      - name: Create DMG
        run: |
          hdiutil create -volname "DNSTT Client" \
            -srcfolder build/macos/Build/Products/Release/DNSTT_XYZ.app \
            -ov -format UDZO \
            DNSTT-Client-macOS-intel.dmg

      - name: Upload macOS Intel artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-dmg
          path: DNSTT-Client-macOS-intel.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install CMake and Perl
        run: choco install cmake strawberryperl -y

      - name: Build Go library for Windows
        run: |
          cd go_src
          $env:CGO_ENABLED=1
          go build -trimpath -ldflags="-s -w" -buildmode=c-shared -o dnstt.dll ./desktop

      - name: Build slipstream-client for Windows
        run: |
          cd vendor/slipstream-rust
          $env:RUSTFLAGS="--remap-path-prefix=$(Get-Location)=/build/s"
          cargo build -p slipstream-client --release --features openssl-vendored
          New-Item -ItemType Directory -Force -Path ../../windows/runner/tools
          Copy-Item target/release/slipstream-client.exe ../../windows/runner/tools/

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows app
        run: flutter build windows --release

      - name: Copy binaries to build
        run: |
          Copy-Item go_src/dnstt.dll build/windows/x64/runner/Release/
          Copy-Item windows/runner/tools/slipstream-client.exe build/windows/x64/runner/Release/

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath DNSTT-Client-Windows.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: DNSTT-Client-Windows.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev perl

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Go library for Linux
        run: |
          cd go_src
          CGO_ENABLED=1 go build -trimpath -ldflags="-s -w" -buildmode=c-shared -o libdnstt.so ./desktop

      - name: Build slipstream-client for Linux
        run: |
          cd vendor/slipstream-rust
          RUSTFLAGS="--remap-path-prefix=$(pwd)=/build/s --remap-path-prefix=$HOME=/_" \
          cargo build -p slipstream-client --release --features openssl-vendored
          mkdir -p ../../linux/tools
          cp target/release/slipstream-client ../../linux/tools/slipstream-client
          chmod +x ../../linux/tools/slipstream-client

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux app
        run: flutter build linux --release

      - name: Copy libraries to build
        run: |
          cp go_src/libdnstt.so build/linux/x64/release/bundle/lib/
          cp linux/tools/slipstream-client build/linux/x64/release/bundle/lib/
          chmod +x build/linux/x64/release/bundle/lib/slipstream-client

      - name: Create tarball
        run: |
          cd build/linux/x64/release/bundle
          tar -czvf ../../../../../DNSTT-Client-Linux.tar.gz .

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: DNSTT-Client-Linux.tar.gz

  create-release:
    needs: [build-android, build-macos-arm64, build-macos-intel, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Get version number
        id: version
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name }}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Rename artifacts
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p release
          # Android APKs
          cp artifacts/android-apks/app-armeabi-v7a-release.apk "release/DNSTT-Client-${VERSION}-Android-armeabi-v7a.apk"
          cp artifacts/android-apks/app-arm64-v8a-release.apk "release/DNSTT-Client-${VERSION}-Android-arm64-v8a.apk"
          cp artifacts/android-apks/app-x86_64-release.apk "release/DNSTT-Client-${VERSION}-Android-x86_64.apk"
          # macOS
          cp artifacts/macos-arm64-dmg/DNSTT-Client-macOS-arm64.dmg "release/DNSTT-Client-${VERSION}-macOS-arm64.dmg"
          cp artifacts/macos-intel-dmg/DNSTT-Client-macOS-intel.dmg "release/DNSTT-Client-${VERSION}-macOS-intel.dmg"
          # Windows (alpha - Slipstream Windows support is new)
          cp artifacts/windows-zip/DNSTT-Client-Windows.zip "release/DNSTT-Client-${VERSION}-alpha-Windows.zip"
          # Linux (alpha - Slipstream Linux support is new)
          cp artifacts/linux-tarball/DNSTT-Client-Linux.tar.gz "release/DNSTT-Client-${VERSION}-alpha-Linux.tar.gz"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: DNSTT Client ${{ github.event.inputs.version || github.ref_name }}
          body: |
            ## DNSTT Client Release

            **Now with Slipstream protocol support** - QUIC-over-DNS tunnel for ~5x faster speeds.

            ### Downloads

            #### Android
            - **ARM64 (64-bit)** - Most modern Android phones
            - **ARMv7 (32-bit)** - Older Android phones
            - **x86_64** - Emulators/Chromebooks

            #### macOS
            - **Apple Silicon (M1/M2/M3)**
            - **Intel**

            #### Other Desktop
            - **Windows**
            - **Linux**

            ### Protocols
            - **DNSTT** - DNS-encoded tunnel (KCP + Noise encryption)
            - **Slipstream** - QUIC-over-DNS tunnel (faster, TLS 1.3)

            ### Notes
            - **Android**: Tunnels all device traffic through DNS (VPN mode) or local proxy
            - **Desktop**: Runs a SOCKS5 proxy - configure your apps to use it

            ### How to Use (Desktop)
            1. Download and install the app for your platform
            2. Add a configuration (DNSTT or Slipstream)
            3. Select a DNS server
            4. Click Connect
            5. Configure your browser/apps to use the SOCKS5 proxy shown in the app
          draft: false
          prerelease: ${{ contains(github.event.inputs.version || github.ref_name, 'beta') || contains(github.event.inputs.version || github.ref_name, 'alpha') || contains(github.event.inputs.version || github.ref_name, 'rc') }}
          files: |
            release/*
